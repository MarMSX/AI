/***************************************************************************
 *   perceptron_iris_full.c                                                *
 *                                                                         *
 *   Copyright (C) 2021 by Marcelo Silveira                                *
 *   MarMSX: http://marmsx.msxall.com                                      *
 *   Contact: flamar98@hotmail.com                                         *
 *                                                                         *
 *  License: GNU-GPL v. 3.x                                                *
 *  http://www.gnu.org/licenses/gpl-3.0.txt                                *
 *                                                                         *
 ***************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <time.h>

// Architecture
const N=70, NT=30, epochs=10, num_attributes=4, target = 4;
double weight[4];
double bias, a=0.01;

// Data - flower iris setosa and Ã­ris versicolor - sepal and petal - length and width - 4 attributes
double train_set[70][5] = {{5.1,3.5,1.4,0.2,0}, {4.9,3.0,1.4,0.2,0}, {4.7,3.2,1.3,0.2,0}, {4.6,3.1,1.5,0.2,0}, {5.0,3.6,1.4,0.2,0}, {5.4,3.9,1.7,0.4,0}, {4.6,3.4,1.4,0.3,0}, {5.0,3.4,1.5,0.2,0}, {4.4,2.9,1.4,0.2,0}, {4.9,3.1,1.5,0.1,0}, {5.4,3.7,1.5,0.2,0}, {4.8,3.4,1.6,0.2,0}, {4.8,3.0,1.4,0.1,0}, {4.3,3.0,1.1,0.1,0}, {5.8,4.0,1.2,0.2,0}, {5.7,4.4,1.5,0.4,0}, {5.4,3.9,1.3,0.4,0}, {5.1,3.5,1.4,0.3,0}, {5.7,3.8,1.7,0.3,0}, {5.1,3.8,1.5,0.3,0}, {5.4,3.4,1.7,0.2,0}, {5.1,3.7,1.5,0.4,0}, {4.6,3.6,1.0,0.2,0}, {5.1,3.3,1.7,0.5,0}, {4.8,3.4,1.9,0.2,0}, {5.0,3.0,1.6,0.2,0}, {5.0,3.4,1.6,0.4,0}, {5.2,3.5,1.5,0.2,0}, {5.2,3.4,1.4,0.2,0}, {4.7,3.2,1.6,0.2,0}, {4.8,3.1,1.6,0.2,0}, {5.4,3.4,1.5,0.4,0}, {5.2,4.1,1.5,0.1,0}, {5.5,4.2,1.4,0.2,0}, {4.9,3.1,1.5,0.1,0}, {7.0,3.2,4.7,1.4,1}, {6.4,3.2,4.5,1.5,1}, {6.9,3.1,4.9,1.5,1}, {5.5,2.3,4.0,1.3,1}, {6.5,2.8,4.6,1.5,1}, {5.7,2.8,4.5,1.3,1}, {6.3,3.3,4.7,1.6,1}, {4.9,2.4,3.3,1.0,1}, {6.6,2.9,4.6,1.3,1}, {5.2,2.7,3.9,1.4,1}, {5.0,2.0,3.5,1.0,1}, {5.9,3.0,4.2,1.5,1}, {6.0,2.2,4.0,1.0,1}, {6.1,2.9,4.7,1.4,1}, {5.6,2.9,3.6,1.3,1}, {6.7,3.1,4.4,1.4,1}, {5.6,3.0,4.5,1.5,1}, {5.8,2.7,4.1,1.0,1}, {6.2,2.2,4.5,1.5,1}, {5.6,2.5,3.9,1.1,1}, {5.9,3.2,4.8,1.8,1}, {6.1,2.8,4.0,1.3,1}, {6.3,2.5,4.9,1.5,1}, {6.1,2.8,4.7,1.2,1}, {6.4,2.9,4.3,1.3,1}, {6.6,3.0,4.4,1.4,1}, {6.8,2.8,4.8,1.4,1}, {6.7,3.0,5.0,1.7,1}, {6.0,2.9,4.5,1.5,1}, {5.7,2.6,3.5,1.0,1}, {5.5,2.4,3.8,1.1,1}, {5.5,2.4,3.7,1.0,1}, {5.8,2.7,3.9,1.2,1}, {6.0,2.7,5.1,1.6,1}, {5.4,3.0,4.5,1.5,1}};

double test_set[30][5] = {{5.0,3.2,1.2,0.2,0}, {5.5,3.5,1.3,0.2,0}, {4.9,3.1,1.5,0.1,0}, {4.4,3.0,1.3,0.2,0}, {5.1,3.4,1.5,0.2,0}, {5.0,3.5,1.3,0.3,0}, {4.5,2.3,1.3,0.3,0}, {4.4,3.2,1.3,0.2,0}, {5.0,3.5,1.6,0.6,0}, {5.1,3.8,1.9,0.4,0}, {4.8,3.0,1.4,0.3,0}, {5.1,3.8,1.6,0.2,0}, {4.6,3.2,1.4,0.2,0}, {5.3,3.7,1.5,0.2,0}, {5.0,3.3,1.4,0.2,0}, {6.0,3.4,4.5,1.6,1}, {6.7,3.1,4.7,1.5,1}, {6.3,2.3,4.4,1.3,1}, {5.6,3.0,4.1,1.3,1}, {5.5,2.5,4.0,1.3,1}, {5.5,2.6,4.4,1.2,1}, {6.1,3.0,4.6,1.4,1}, {5.8,2.6,4.0,1.2,1}, {5.0,2.3,3.3,1.0,1}, {5.6,2.7,4.2,1.3,1}, {5.7,3.0,4.2,1.2,1}, {5.7,2.9,4.2,1.3,1}, {6.2,2.9,4.3,1.3,1}, {5.1,2.5,3.0,1.1,1}, {5.7,2.8,4.1,1.3,1}};

double initialize_weight()
{
  int N = rand() % 100;

  return 25.0 / N;
}

void initialize_weights() 
{
  int i;
  srand(time(NULL));

  for (i=0; i<num_attributes; i++)
    weight[i] = initialize_weight();

  bias = initialize_weight();
}

double evaluate(int line_no, int stage_train)
{
  int sum=0, i;

  for (i=0; i<num_attributes; i++)
  {
    if (stage_train)
      sum += train_set[line_no][i] * weight[i];
    else
      sum += test_set[line_no][i] * weight[i];
  }

  sum += bias;

  return sum > 0.5;
}

void train()
{
  double s, e, erro;
  int line_no, i, ep;

  for (ep=0; ep<epochs; ep++)
  {
    erro = 0;

    for (line_no=0; line_no<N; line_no++)
    {
      s = evaluate(line_no, 1);
      e = train_set[line_no][target] - s;

      for (i=0; i<num_attributes; i++)
        weight[i] += a * e * train_set[line_no][i];

      bias += a * e;

      if (e != 0)
        erro++;
    }
    erro = erro / N;
    printf("Epoch %d - error = %.2f\n", ep+1, erro);
  }
}

void test()
{
  int errors=0, line_no;
  double s;

  for (line_no=0; line_no<NT; line_no++)
  {
    s = evaluate(line_no, 0);

    printf("Element: %d / target: %.2f / Pred: %.2f\n", line_no+1, test_set[line_no][target], s);

    if (s != test_set[line_no][target])
      errors++;
  }

  printf("Errors in test: %d\n", errors);
}

main() 
{
  printf("Initialize weights ...\n");
  initialize_weights();
  printf("Start training ...\n");
  train();
  printf("Start testing ...\n");
  test();
}
